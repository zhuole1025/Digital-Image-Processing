# 灰度变换与空间滤波
### 背景知识
* 空间域指包含图像像素的平面，灰度变换与空间滤波均在空间域进行，即直接在图像像素上操作，表示为 $g(x,y)=T[f(x,y)]$ ，其中 $T$ 是在点 $(x, y)$ 的邻域上定义的关于 $f$ 的一种算子
    * 如空间滤波：邻域与预定义的操作共称为空间滤波器（也称为空间掩膜、核、模版或窗口）  
    *  空间滤波的最小邻域为 $1\times1$ ，此时 $T$ 成为灰度变换函数：$s=T(r)$ ，可以起到对比度拉伸或阈值处理的作用
* 图像增强应用
    * 增强是指对图像进行加工，使其结果对于**特定**的应用比原始图像更适合的一种处理

---

### 灰度变换函数
* 图像反转
    * $s=L-1-r$
    * 适用于增强嵌入在一幅图像的暗区域中的白色或灰色细节，特别当黑色面积在尺寸上站主导地位时
* 对数变换
    * $s=clog(1+r)$
    * 该变换将输入中范围较窄的低灰度值映射为输出中较宽范围的灰度值；对高的输入灰度值起相反作用
    * 使用对数变换来扩展图像中暗像素的值，同时压缩更高灰度级的值
    * 反对数变换与对数变换相反
    * 对数变换可以压缩像素值变化较大的图像的动态范围，比如傅立叶频谱。傅立叶频谱的范围一般在 $0\sim10^6$ ，通过对数变换后可以显示图像中丰富的细节
* 幂律（伽马）变换
    * $s=cr^\gamma$
    * 随着 $\gamma$ 的变化，得到一族可能的变换曲线（分界点为 $\gamma = 1$ ，此时简化成了恒等变换）
    * 用于图像获取、显示、打印的各种设备常根据幂律来产生相应，因此应用**伽马矫正**来矫正这些幂律响应现象
    * 幂律变换同样可用于调整图像的对比度：当 $\gamma\lt1$ 时，减小对比度；当 $\gamma\gt1$ 时，增加对比度
* 分段线性变换函数
    * 对比度拉伸：一般函数是单值且单调递增的，保持了灰度级的次序（包括了阈值处理函数）
    * 灰度级分层：用于突出图像特定灰度范围的亮度
        * 一种方法将感兴趣范围内所有灰度显示为一个值，将其他灰度值显示为另一个值
        * 另一种方法使感兴趣范围的灰度变亮（或变暗），而保持图像中的其他灰度级不变
    * **比特平面分层**：将 256 级灰度图像分成 8 个 1 比特平面来表示，通过阈值灰度变换函数处理来得到对应平面的二值图像
        * 可用于图像压缩：通过特定几个平面来恢复图像

---

### 直方图处理
* 直方图定义：$p(r_k)=\frac{n_k}{MN}$ （类比概率）
* 直方图均衡
    * 灰度映射：$s=T(r)$
      * $T(r)$ 在区间 $0\leq r\leq L-1$ 上为（严格）单调递增函数
      * 当 $0\leq r\leq L-1$ 时，$0\leq T(r)\leq L-1$
    * 重要变换函数：$s=T(r)=(L-1)\int^r_0p_r(w)dw$
    * 离散形式：$s_k=T(r_k)=(L-1)\sum^k_{j=0}p_r(r_j)=\frac{(L-1)}{MN}\sum^k_{j=0}n_j,\ k=0, 1, 2, ...,L-1$ 
    * 对于该变换函数，恒有 $p_s(s)=p_r(r)|\frac{dr}{ds}|=p_r(r)|\frac{1}{(L-a)p_r(r)}|=\frac{1}{L-1}$ ，即 $p_s(s)$ 始终是均匀的，与 $p_r(r)$ 的形式无关
    * 只要图像直方图中没有为 0 的分量，就满足严格单调递增，可以进行反变换 $r_k=T^{-1}(s_k)$
    * 局部直方图均衡，自适应直方图均衡
    * [参考资料](https://zhuanlan.zhihu.com/p/44918476)
* 直方图匹配
    * 直方图匹配（规范化）用于在处理后产生特殊直方图
    * 步骤
        1. 由输入图像得到 $p_r(r)$ ，并通过直方图均衡得到 $s$ 的值
        2. 通过 $G(z)=(L-1)\int^z_0p_z(t)dt=s$ 中指定的 $p_z(z)$ 求得变换函数 $G(z)$ ；对于离散函数，用 $G(z_q)=(L-a)\sum^q_{i=0}p_z(z_i)$ 对 $q=0,1,...,L-1$ 计算变换函数 $G$ 的所有值，将其四舍五入为范围 $[0,L-1]$ 内的整数，存入一个表中
        3. 求得反变换函数 $=G^{-1}(z)$ ；对于离散函数，对每一个值 $s_k$ 找到对应的 $z_q$ 值，以使 $G(z_q)$ 最接近 $s_k$ ，并储存这些从 $s$ 到 $k$ 的映射，当映射不唯一时，按惯例选择最小的值
        4. 对经过直方图均衡的图像中每个像素执行反变换函数，最后输出图像的 PDF 将等于指定的 PDF；对于离散函数，使用上一步找到的映射把该图像每个均衡后的像素值 $s_k$ 映射为直方图规定化后的图像中相应的 $z_q$ 值，形成直方图规范化后的图像
* 在图像增强中使用直方图统计
    * 平均灰度、灰度方差
    * 局部均值、局部方差：与全局均值、方差做比较来判断当前区域的亮度和对比度特征
